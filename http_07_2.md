# Chapter 2. Architecture - Unit 7. Cache - section 7 ~ 9

## 7. 캐시 처리 단계

- 요청받기
    - 네트워크 커넥션에서의 활동을 감지하여 데이터 읽어들임
- 파싱
    - 메시지를 여러 부분으로 파싱하여 헤더부분을 조작하기 쉬운 자료구조에 담음
    - 캐싱 소프트웨어가 헤더 필드를 처리하기 조작하기 쉽도록 함
- 검색
    - URL 을 알아내어 그에 해당하는 로컬 사본이 있는지 검사
    - 사본은 메모리나 디스크에 있을 수도 있고, 근처의 다른 컴퓨터에 있을 수도 있음
    - 캐시된 객체는 서버 응답 본문과 원서버 응답 헤더를 포함하고 있음
- 신선도 검사
    - 캐시된 시간 이후로 특정 시간이 지나면 캐시는 문서를 제공하기 전에 문서에 어떤 변경이 있었는지 검사하기 위해 버와 재검사를 해야 함
- 응답 생성
    - 캐시된 응답을 원 서버에서 온 것처럼 보이게 하고 싶기 때문에 캐시는 캐시된 서버 응답 헤더를 토대로 응답 헤더를 생성함
    - 이 기저 헤더는 캐시에 의해 수정되고 늘어남
        - HTTP 버전에 따라 헤더 번역
        - 캐시 신선도 정보 삽입(Cache-control, Age, Expires 헤더)
        - 종종 Via 헤더 포함
        - Date 헤더를 수정해서는 안됨
- 발송(전송)
    - 응답을 클라이언트에게 돌려줌
- 로깅
    - 로그파일과 캐시 사용 통계를 유지함
    - 각 캐시 트랜잭션이 완료되면 로그되는 것
        - 캐시 적중/부적중 횟수 갱신
        - 요청 종류
        - URL
        - 결과
        - 스퀴드 로그 포맷, 넷스케이프 확장 공용 로그 포맷이 가장 많이 쓰임

## 8. 사본을 신선하게 유지

- 캐시된 사본이 서버와 충분히 일치하도록 유지할 수 있게 해주는 단순한 매커니즘
    - 문서 만료
    - 서버 재검사

### 8.1 문서 만료

- 원 서버가 각 문서에 유기간을 붙일 수 있음(콘텐츠가 얼마나 신선하게 보이는지)
    - Cache-Control: max-age 헤더
    - Expires 헤더
- 클라이언트 요청에 캐시되었거나 검사되지 않은 리소스의 제공을 거부하는 헤더가 포함되어있지 않은 한, 캐시는 만료되지 않은(=신선한) 문서를 서버와의 접촉없이 사본을 제공할 수 있다
- 캐시된 문서가 만료되면 캐시는 반드시 서버에 문서에 변경된 것이 있는지 검사해야 하며,
    - 변경되지 않았다면 새 유효기간과 기타 헤더만을을 얻어온다
    - 변경되었다면 신선한 사본과 새 유효기간을 얻어온다

### 8.3 서버 재검사

- 캐시된 문서가 만료되어 캐시가 원 서버에게 문서가 변경되었는지 여부를 물어보는 것
- HTTP 는 캐시가 다음 중 하나를 반환하는 적절한 행동을 할 것을 요구 :
    - 충분히 신선한 사본 - 신선하거나 재검사해서 다시 받아온 사본
    - 재검사되어 신선하다고 확신할 수 있는 사본
    - 에러 메시지(원서버가 다운된 경우)
    - 경고 메시지가 부착된 사본
- 조건부 요청 헤더
    - 재검사를 효율적으로 만들어줌
    - 변경되지 않았다면 304 헤더 응답
    - If-Modified-Since(IMS)
        - 주어진 날짜 이후에 리소스가 변경되지 않았다면 요청을 제한
    - If-None-Match
        - 문서의 엔터티 태그(일련번호와 같은 특별한 태그)가 주어진 엔터티 태그와 일치하지 않는 경우에만 문서를 가져옴
        - 약한 검사기와 강한 검사기 지원
    - 클라이언트로부터 두 헤더 모두 받았다면 캐시나 서버는 모든 헤더의 조건에 부합하지 않는 한 304 를 응답해서는 안됨

## 9. 캐시 제어

- 서버가 문서가 만료되기 전까지 얼마나 오랫동안 캐시될 수 있게 할 것인지 설정할 수 있는 방법
    - Cache-Control: no-store, no-cache 헤더
        - 캐시가 검증되지 않은 객체로 응답하는 것을 막음
        - no-store은 사본 만드는 것을 금지, no-cache는 재검사없이 사본 제공 금지
    - Cache-Control: must-revalidate 헤더
        - 캐시가 신선하지 않은 사본을 원 서버와의 최초의 재검사 없이는 제공해서는 안됨
    - Cache-Control: max-age 헤더
        - 서버로부터 온 이후로 흐른 시간
    - Expires 헤더
        - 실제 만료 날짜
        - Expires: 0 은 문법 위반이며 어떤 소프트웨어와 문제를 일으킬 수 있음
    - 아무 정보도 주지않고 캐시가 휴리스틱하게 결정
        - LM 인자 알고리즘
            - 마지막으로 변경된 것이 상당히 예전이라면 그것은 아마 안정적인 문서일 것이고 갑자기 바뀔 가능성은 별로 크지 않을 것이므로 캐시에 더 오래 보관하고 있어도 안전
            - 최근에 변경되었다면 그것은 아마 자주 변경될 것이고 따라서 우리는 그것을 서버와 재검사하기 전까지 짧은 기간 동안만 캐시해야 함
        - 신선도 유지기간에 상한을 설정하여 지나치게 커지는 것을 막아야 함

### 9.6 클라이언트의 신선도 제약

- Cache-Control: max-stale : 신선하지 않은 문서라도 자유롭게 받을 수 있음
- Cache-Control:min-fresh : 지금으로부터 적어도 s 초 후까지 신선한 문서만을 원함
- Cache-Control:max-age : 캐시는 s 초 보다 오랫동안 캐시되었던 문서를 받지 않음
- Cache-Control:no-cache : 리소스를 재검사하기 전까지는 받아들이지 않음
- Cache-Control:no-store : 민감한 정보가 들어있으므로 캐시에 사본 저장을 허용하지 않음
- Cache-Control:only-if-cached : 캐시의 사본만을 원함
